@page "/project-details/{Id:int}"
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudContainer Fixed="true" Class="mt-4">
    @if (project != null)
    {
        <MudGrid>
            <MudItem xs="12">
                <div class="d-flex justify-space-between align-center">
                    <MudText Typo="Typo.h4">Project Details</MudText>
                    <MudButton OnClick="GoBack"
                               StartIcon="@Icons.Material.Filled.ArrowBack"
                               Color="Color.Default">
                        Back to Projects
                    </MudButton>
                </div>
            </MudItem>

            <MudItem xs="12" Class="mt-4">
                <MudTimeline TimelineOrientation="TimelineOrientation.Horizontal" TimelineAlign="TimelineAlign.Start">
                    @foreach (var phase in projectPhases)
                    {
                        <MudTimelineItem Color="@GetPhaseColor(phase)"
                                         Size="@(phase.Id == 4 ? Size.Large : Size.Medium)"
                                         Variant="@(phase.Id == 4 ? Variant.Filled : Variant.Outlined)">
                            <ItemContent>
                                <MudText Color="@GetPhaseColor(phase)"
                                         Style="cursor: pointer;"
                                         Class="hover-component"
                                         @onclick="() => NavigateToPhase(phase.Id)">
                                    @phase.Name
                                </MudText>
                            </ItemContent>
                        </MudTimelineItem>
                    }
                </MudTimeline>
            </MudItem>

            <MudGrid Class="mt-4">
                <MudItem xs="12" sm="3" Style="display: flex">
                    <MudCard Elevation="3" Class="hover-card" @onclick="@(() => NavigateToToolTree())" Style="height: 100%; width: 100%">
                        <MudCardContent Style="display: flex; flex-direction: column; justify-content: center; align-items: center">
                            <MudText Typo="Typo.h3" Align="Align.Center">Tooltree</MudText>
                            <MudText Typo="Typo.h3" Align="Align.Center" Color="@(IsCompleted ? Color.Success : Color.Warning)" Style="margin-top: 12px">
                                @(IsCompleted ? "Completed" : "In Progress")
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" sm="3" Style="display: flex">
                    <MudCard Elevation="3" Class="hover-card" @onclick="@(() => NavigateToDeliverables())" Style="height: 100%; width: 100%">
                        <MudCardContent Style="display: flex; flex-direction: column; justify-content: center; align-items: center">
                            <MudText Typo="Typo.h3" Align="Align.Center">Deliverables</MudText>
                            <MudText Typo="Typo.h1" Align="Align.Center" Color="Color.Primary" Style="margin-top: 16px">50%</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" sm="3" Style="display: flex">
                    <MudCard Elevation="3" Class="hover-card" @onclick="@(() => NavigateToStatus())" Style="height: 100%; width: 100%">
                        <MudCardContent Style="display: flex; flex-direction: column; justify-content: center; align-items: center">
                            <MudText Typo="Typo.h3" Align="Align.Center">Status</MudText>
                            <div Style="margin-top: 16px">
                                <MudText Typo="Typo.h2" Align="Align.Center">
                                    Doc: <span style="color: var(--mud-palette-primary)">34%</span>
                                </MudText>
                                <MudText Typo="Typo.h2" Align="Align.Center">
                                    Edu: <span style="color: var(--mud-palette-primary)">32%</span>
                                </MudText>
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" sm="3" Style="display: flex">
                    <MudCard Elevation="3" Class="hover-card" @onclick="@(() => NavigateToDFS())" Style="height: 100%; width: 100%">
                        <MudCardContent>
                            <MudText Typo="Typo.h3" Align="Align.Center">DFS</MudText>
                            <MudSimpleTable>
                                <thead>
                                    <tr>
                                        <th>DRM</th>
                                        <th>FAT</th>
                                        <th>SAT</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>12</td>
                                        <td>23</td>
                                        <td>32</td>
                                        <td style="color: green">OK</td>
                                    </tr>
                                    <tr>
                                        <td>5</td>
                                        <td>14</td>
                                        <td>26</td>
                                        <td style="color: orange">Progress</td>
                                    </tr>
                                    <tr>
                                        <td>34</td>
                                        <td>17</td>
                                        <td>29</td>
                                        <td style="color: red">NOK</td>
                                    </tr>
                                </tbody>
                            </MudSimpleTable>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>

            <!-- Basic Information and Key Dates Cards -->
            <MudGrid Class="mt-4">
                <!-- ... (pozostała część kodu bez zmian) ... -->
            </MudGrid>

            <!-- Project Team Section -->
            <MudGrid Class="mt-4">
                <!-- ... (pozostała część kodu bez zmian) ... -->
            </MudGrid>
        </MudGrid>
    }
    else
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
</MudContainer>

<style>
    .hover-component {
        transition: all 0.3s ease-in-out;
        position: relative;
        padding: 10px;
        border-radius: 4px;
        display: inline-block;
    }

        .hover-component:hover {
            background-color: rgba(12, 128, 233, 0.2);
            transform: scale(1.1);
        }

    .hover-card {
        transition: all 0.3s ease-in-out;
        cursor: pointer;
    }

        .hover-card:hover {
            transform: scale(1.02);
            border: 2px solid var(--mud-palette-primary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
</style>

@code {
    [Parameter] public int Id { get; set; }
    private Project project;
    private List<ProjectPhase> projectPhases = new();
    private bool IsCompleted = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadProject();
    }

    private async Task LoadProject()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        project = await context.Projects
            .Include(p => p.Engineer)
            .Include(p => p.RMResponsible)
            .Include(p => p.Supplier)
            .Include(p => p.ProjectPhase)
            .Include(p => p.ProjectType)
            .FirstOrDefaultAsync(p => p.Id == Id);

        projectPhases = await context.ProjectPhases.OrderBy(p => p.Order).ToListAsync();

        if (project == null)
        {
            Snackbar.Add("Project not found", Severity.Error);
            NavigationManager.NavigateTo("/projects");
        }
    }

    private Color GetProjectTypeColor(ProjectType type) => type?.Color != null
        ? Enum.TryParse<Color>(type.Color, out var color) ? color : Color.Default
        : Color.Default;

    private Color GetPhaseColor(ProjectPhase phase) =>
        phase.Id == project.ProjectPhaseId ? Color.Primary :
        phase.Id == 4 ? Color.Success : Color.Default;

    private void GoBack() => NavigationManager.NavigateTo("/projects");
    private void NavigateToPhase(int phaseId) => NavigationManager.NavigateTo($"/tasks/{project.Id}/{phaseId}");
    private void NavigateToDeliverables() => NavigationManager.NavigateTo($"/deliverables/{project.Id}");
    private void NavigateToStatus() => NavigationManager.NavigateTo($"/status/{project.Id}");
    private void NavigateToDFS() => NavigationManager.NavigateTo($"/dfs/{project.Id}");
    private void NavigateToToolTree() => NavigationManager.NavigateTo($"/tooltree/{project.Id}");
}
